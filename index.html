<!doctype html>
<html>
<head>
    <meta charset="utf8">
    <title>WebAssembly stack tester</title>
</head>
<body>

<h3>Compile:</h3>
<div>
    <button onclick="compileBuffer('test-no-names.wasm')">ArrayBuffer (no names)</button>
    <button onclick="compileBuffer('test-with-names.wasm')">ArrayBuffer (with names)</button>
    <button onclick="compileStreaming('test-no-names.wasm')">Response (no names)</button>
     <button onclick="compileStreaming('test-with-names.wasm')">Response (with names)</button>
</div>

<h3>Run:</h3>
<div>
    <button onclick="onClickPrintStack()">Print Error.stack</button>
    <button onclick="onClickThrowError()">Throw uncaught Error</button>
</div>

<h3>Current instance:</h3>
<div id='currentInstance'>None</div>

<h3>Output:</h3>
<div id='output'></div>

<script>
    const currentInstance = document.getElementById('currentInstance');
    var instance;

    const output = document.getElementById('output');

    const importObj = { js: {
        doPrint() { output.innerHTML += (new Error().stack).replace(/\n/g, '<br>') + "<br>"; },
        doThrow() { output.innerHTML += "Threw (check Web Console) <br><br>"; throw new Error("thrown on purpose"); }
    } };

    function compileBuffer(file) {
        fetch(file)
        .then(response => response.arrayBuffer())
        .then(buffer => WebAssembly.instantiate(buffer, importObj))
        .then(result => {
            instance = result.instance;
            currentInstance.innerHTML = "Compiled " + file + " via ArrayBuffer";
        })
        .catch(err => {
            alert("Error: " + err);
        });
    }

    function compileStreaming(file) {
        WebAssembly.instantiateStreaming(fetch(file), importObj)
        .then(result => {
            instance = result.instance;
            currentInstance.innerHTML = "Compiled fetch(\"" + file + "\")";
        })
        .catch(err => {
            output.innerHTML += "Error: " + err + "<br><br>";
        });
    }

    function onClickPrintStack() {
        print = true;
        if (!instance) {
            alert("Compile something first");
            return;
        }
        instance.exports.printStack();
    }

    function onClickThrowError() {
        print = true;
        if (!instance) {
            alert("Compile something first");
            return;
        }
        instance.exports.throwError();
    }
</script>
</body>
</html>
